{% extends "header.html" %}
{% block content %}
<div style="height:100%">
    <div style="float: left;width:15%;height:92vh;border-right: 1px solid grey;" id="users">
        {% for user in users %}
            <div id="{{user}}" style="margin-top:10px; border: 2px solid #dedede;background-color: #ddd;border-radius: 5px;border-color: #ccc;display:grid;grid-gap:2px; grid-template-areas:'text image';grid-template-columns:80% 20%;" onclick="userOnClick(this.id)">
                <p style="grid-area:text; text-align: center;">{{user}}</p>
                <img src="../static/img/userDumy.png" style="grid-area:image" />
            </div>
        {% endfor %}
    </div>
    <div style="width:100%; padding: 20px; overflow-y: scroll; float:right;width:80%;height:85vh">
        <div id="messages"></div>
        <div style="padding-top: 20px;position: fixed;bottom:3%;width:100%;">
            <form onsubmit="return sendMessage()" style="">
                <input id="message" type="text" style="width: 65%;">
                <button style="width: 10%">Send</button>
            </form>
        </div>
    </div>
</div>
    <script>
    var username = prompt("Please enter your name:", "User1");
    var ws = new WebSocket("ws://192.168.0.234:8888/websocket/"+username.replace(" ","").toLowerCase());

    function sendMessage() {
        var txtMessage = document.getElementById("message");
        var message = txtMessage.value;
        var today = new Date();
        var time = today.getHours() + ":";
        if(today.getMinutes()<10){
            time=time+"0"+today.getMinutes();
        }else {
            time = time + today.getMinutes();
        }
        var payload = {
            "message": message,
            "user": username,
            "time": time
        }
        ws.send(JSON.stringify(payload));
        txtMessage.value = "";
        return false;
    }

    ws.onmessage = function(evt) {
        var messageDict = JSON.parse(evt.data);
        var messageBox = document.createElement("div");
        var text = document.createElement("p");
        text.innerHTML=messageDict.message;
        var time = document.createElement("p");
        time.innerHTML = messageDict.time;

        if(username==messageDict.user){
            messageBox.style="margin-top:10px;  width:80%;float:right;border: 2px solid #dedede;background-color: #ddd;border-radius: 5px;border-color: #ccc;display:grid;grid-gap:2px; grid-template-areas:'text''time';";
            text.style="grid-area:text; text-align: right; padding-right:10px;padding-top:5px;";
            time.style="color: #aaa;grid-area:time;text-align:right;padding-right:10px;";
        } else {
            messageBox.style="margin-top:10px; width:80%;float:left;border: 2px solid #dedede;background-color: #f1f1f1;border-radius: 5px;display:grid;grid-gap:2px; grid-template-areas:'text''time';";
            text.style="grid-area:text;text-align: left;padding-left:10px;padding-top:5px;";
            time.style="color: #999;grid-area:time;text-align: left;padding-left:10px;";
        }

        messageBox.appendChild(text);
        messageBox.appendChild(time);

        document.getElementById("messages").appendChild(messageBox);
    };

    function userOnClick(id){
        ws.close();
        alert("You clicked on: " + id);
        if(username>id){
            ws = new WebSocket("ws://127.0.0.1:8888/websocket/"+username.replace(" ","").toLowerCase()+id.toLowerCase());
        } else {
            ws = new WebSocket("ws://127.0.0.1:8888/websocket/"+id.toLowerCase()+username.replace(" ","").toLowerCase());
        }

            function sendMessage() {
        var txtMessage = document.getElementById("message");
        var message = txtMessage.value;
        var today = new Date();
        var time = today.getHours() + ":";
        if(today.getMinutes()<10){
            time=time+"0"+today.getMinutes();
        }else {
            time = time + today.getMinutes();
        }
        var payload = {
            "message": message,
            "user": username,
            "time": time
        }
        ws.send(JSON.stringify(payload));
        txtMessage.value = "";
        return false;
    }

    ws.onmessage = function(evt) {
        var messageDict = JSON.parse(evt.data);
        var messageBox = document.createElement("div");
        var text = document.createElement("p");
        text.innerHTML=messageDict.message;
        var time = document.createElement("p");
        time.innerHTML = messageDict.time;

        if(username==messageDict.user){
            messageBox.style="margin-top:10px;  width:80%;float:right;border: 2px solid #dedede;background-color: #ddd;border-radius: 5px;border-color: #ccc;display:grid;grid-gap:2px; grid-template-areas:'text''time';";
            text.style="grid-area:text; text-align: right; padding-right:10px;padding-top:5px;";
            time.style="color: #aaa;grid-area:time;text-align:right;padding-right:10px;";
        } else {
            messageBox.style="margin-top:10px; width:80%;float:left;border: 2px solid #dedede;background-color: #f1f1f1;border-radius: 5px;display:grid;grid-gap:2px; grid-template-areas:'text''time';";
            text.style="grid-area:text;text-align: left;padding-left:10px;padding-top:5px;";
            time.style="color: #999;grid-area:time;text-align: left;padding-left:10px;";
        }

        messageBox.appendChild(text);
        messageBox.appendChild(time);

        document.getElementById("messages").appendChild(messageBox);
    };
    }
    </script>

{% endblock %}

